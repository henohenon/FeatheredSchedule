<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimerList</title>

    <link rel="stylesheet" type="text/css" href="../../global.css">
    <style>
        #timerList{
            display: grid;
            grid-template-rows: auto;
            gap: 5px 5px;
            margin: 10px;
        }
        iframe{
            height: 76px;
        }
    </style>
</head>
<body>
    <div id="timerList">
    </div>

</body>
<script type="module">
    import {getDB, addData, updateDataById, getAllStoreData, deleteDataById, getDataById, clearAllStoreData} from "../../indexedDB/timer.js"
    const myOrigin = window.location.origin;

    const iframes = {};
    let activeIframeId = -1;

    let db = null;

    //createTimerList(timerData);

    function createTimerList(timeresData){
        const timerList = document.getElementById('timerList');

        timeresData.forEach((timerData) => {
            const iframe = document.createElement("iframe");
            iframe.src = "../../module/timer/card/index.html";
            iframe.id = `iframe-${timerData.id}`;  // 各iframeにidを設定
            timerList.appendChild(iframe);

            iframe.addEventListener("load", function() {
                iframe.contentWindow.postMessage({
                    action: "setData",
                    value: timerData,
                }, myOrigin);
            });
            iframes[timerData.id] = iframe;
        });
    }

    window.addEventListener("message", function (event) {
        if (event.origin !== myOrigin) {
            return;
        }

        switch (event.data.action) {
            case "startedTimer": {
                console.log('timerStart!');
                if(iframes[activeIframeId]){
                    iframes[activeIframeId].contentWindow.postMessage({
                        action: "stopTimer"
                    }, myOrigin);
                }

                activeIframeId = event.data.value.id;
                break;
            }
            case "stoppedTimer": {
                console.log('timerStop!');
                const eventValues = event.data.value;

                console.log(eventValues)
                updateDataById(db, "timeres", {elapsedTime: eventValues.elapsedTime}, parseInt(eventValues.id)).then((rara)=>{
                });
                break;
            }
            default: {
                console.log("event not found:");
                console.log(event.data);
                break;
            }
        }
    });



    const dbName = "FeatheredScheduleTimer";
    const dbVersion = 1;
    getDB().then((getedDB)=>{
        db = getedDB;
        /*
        getDataById(db, "timeres", 12).then((rara)=>{
            console.log(rara)
        });
        clearAllStoreData(db, "timeres");
        updateDataById(db, "timeres", {title: "Tramworks"}, 36).then((rara)=>{
        });
        deleteDataById(db, "timeres", 0).then((rara)=>{
            console.log(rara)
        });
        addData(db, "timeres", {title:"生活", elapsedTime:0, active:0}).then((rara)=>{
            console.log(rara)
        });
        */

            getAllStoreData(db, "timeres").then((datas) =>{
                console.log(datas)
                createTimerList(datas);
            });
    });
</script>
</html>